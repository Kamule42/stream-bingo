name: Deploy to dev

on: workflow_dispatch

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    name: Build frontend
    steps:
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: actions/checkout@v4
      - run: yarn install
        name: install frontend
        working-directory: stream-bingo-frontend
      - run: yarn build
        name: build frontend
        working-directory: stream-bingo-frontend
      - uses: actions/upload-artifact@v4
        with:
          name: frontend
          path: ./stream-bingo-frontend/dist/stream-bingo-frontend/browser/

  build-backend:
    runs-on: ubuntu-latest
    name: Build backend
    steps:
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: actions/checkout@v4
      - run: yarn install
        name: install backend
        working-directory: stream-bingo-backend
      - run: yarn build
        name: build backend
        working-directory: stream-bingo-backend
      - uses: actions/upload-artifact@v4
        with:
          name: backend
          path: ./stream-bingo-backend/dist/
  deploy-to-dev:
    runs-on: ubuntu-latest
    name: Deploy to dev
    needs: [build-frontend, build-backend]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontend
          path: frontend/
      - uses: actions/download-artifact@v4
        with:
          name: backend
          path: backend/
      - uses: burnett01/rsync-deployments@7.0.2
        name: Deploy front
        with:
          switches: -avzr --delete
          path: ./frontend/
          remote_path: /apps/stream-bingo-dev/frontend
          remote_host: ${{ secrets.VPS_IP }}
          remote_user: ${{ secrets.VPS_USER }}
          remote_key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
     
      - uses: burnett01/rsync-deployments@7.0.2
        name: Deploy backend
        with:
          switches: -avzr --delete
          path:  ./backend/
          remote_path: /apps/stream-bingo-dev/backend
          remote_host: ${{ secrets.VPS_IP }}
          remote_user: ${{ secrets.VPS_USER }}
          remote_key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
      # - uses: webfactory/ssh-agent@v0.9.0
      #   with:
      #     ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
      # - run: apt-get install rsync
      # - name: Copy files to VPS
      #   env:
      #     VPS_IP: ${{ secrets.VPS_IP }}
      #     VPS_USER: ${{ secrets.VPS_USER }}
      #   run: |
      #     echo $VPS_IP
      #     echo $VPS_USER
      #     mkdir -p ~/.ssh
      #     ssh-keyscan -H $VPS_IP >> ~/.ssh/known_hosts
      #     rsync -avz --delete ./stream-bingo-frontend/dist/stream-bingo-frontend/browser/ $VPS_USER@$VPS_IP:/apps/stream-bingo-dev/frontend
      #     rsync -avz --delete ./stream-bingo-backend/dist/ $VPS_USER@$VPS_IP:/apps/stream-bingo-dev/backend
